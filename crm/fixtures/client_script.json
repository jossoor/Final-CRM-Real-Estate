[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 1,
  "modified": "2025-09-11 11:34:49.459289",
  "module": null,
  "name": "Assign to full name",
  "script": "frappe.ui.form.on('CRM Lead', {\n  onload(frm) {\n    add_custom_save_button(frm);  // أضف زرارنا الإضافي\n  },\n\n  refresh(frm) {\n    add_custom_save_button(frm);  // أضف زرارنا الإضافي\n  },\n});\n\nfunction add_custom_save_button(frm) {\n  // نتجنب إضافة الزر مرتين\n  if (frm.page.custom_save_btn_added) return;\n  frm.page.custom_save_btn_added = true;\n\n  frm.add_custom_button(__('حفظ مع تحديث التعيينات'), async function () {\n    try {\n      // لو المستند جديد، مفيش ToDo مرتبطة بيه — نحفظه مباشرة\n      if (frm.is_new()) {\n        await frm.save();\n        frappe.show_alert({ message: __('تم الحفظ.'), indicator: 'green' });\n        return;\n      }\n\n      // 1) جيب التعيينات المفتوحة المرتبطة بالـ Lead\n      const todosRes = await frappe.call({\n        method: 'frappe.client.get_list',\n        args: {\n          doctype: 'ToDo',\n          filters: {\n            reference_type: frm.doc.doctype,\n            reference_name: frm.doc.name,\n            status: 'Open',\n          },\n          fields: ['allocated_to'],\n          limit_page_length: 500,\n        },\n      });\n\n      const users = (todosRes?.message || []).map((row) => row.allocated_to);\n\n      // 2) لو فيه مستخدمين: هات الأسماء الكاملة\n      if (users.length > 0) {\n        const usersRes = await frappe.call({\n          method: 'frappe.client.get_list',\n          args: {\n            doctype: 'User',\n            filters: { name: ['in', users] },\n            fields: ['full_name'],\n            limit_page_length: users.length,\n          },\n        });\n\n        const names = (usersRes?.message || [])\n          .map((u) => u.full_name)\n          .filter(Boolean)\n          .join('، ');\n\n        await frm.set_value('assigned_to_display', names || '');\n      } else {\n        await frm.set_value('assigned_to_display', '');\n      }\n\n      // 3) احفظ المستند بعد التحديث\n      await frm.save();\n      frappe.show_alert({ message: __('تم الحفظ بنجاح.'), indicator: 'green' });\n    } catch (e) {\n      console.error(e);\n      frappe.msgprint({\n        title: __('خطأ'),\n        message: __('حصل خطأ أثناء الحفظ. راجع الـ Console للتفاصيل.'),\n        indicator: 'red',\n      });\n    }\n  });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 1,
  "modified": "2025-12-25 13:41:14.695981",
  "module": null,
  "name": "filtered button",
  "script": "// CRM Lead ListView Customizations (Fixed Selection + Correct Doctype + Bulk Assign)\n(function () {\n\t// -----------------------------\n\t// Constants\n\t// -----------------------------\n\tconst DOCTYPE = \"CRM Lead\";\n\n\t// -----------------------------\n\t// Helpers\n\t// -----------------------------\n\tfunction get_listview_fallback() {\n\t\tif (typeof cur_list !== \"undefined\" && cur_list) return cur_list;\n\t\tif (frappe?.views?.list_view) return frappe.views.list_view;\n\t\treturn null;\n\t}\n\n\tfunction get_docname(item) {\n\t\t// ✅ handle strings (most common in some versions)\n\t\tif (typeof item === \"string\") return item;\n\n\t\t// ✅ handle objects\n\t\treturn item?.name || item?.docname || item?.id || item?.value || null;\n\t}\n\n\tfunction normalize_names(items) {\n\t\treturn (items || []).map(get_docname).filter(Boolean);\n\t}\n\n\tfunction get_selected_docnames(listview) {\n\t\tif (!listview || !listview.get_checked_items) return [];\n\n\t\t// 1) try full objects\n\t\tlet selected = [];\n\t\ttry {\n\t\t\tselected = listview.get_checked_items(true) || [];\n\t\t} catch (e) {\n\t\t\tselected = [];\n\t\t}\n\t\tlet names = normalize_names(selected);\n\t\tif (names.length) return names;\n\n\t\t// 2) fallback: names only\n\t\ttry {\n\t\t\tselected = listview.get_checked_items() || [];\n\t\t} catch (e) {\n\t\t\tselected = [];\n\t\t}\n\t\tnames = normalize_names(selected);\n\t\treturn names;\n\t}\n\n\tfunction ensure_names(names) {\n\t\tif (!names || !names.length) {\n\t\t\tfrappe.msgprint(__(\"Please select at least one lead\"));\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\t// -----------------------------\n\t// Override frappe.confirm globally (only for Clear Assignment)\n\t// -----------------------------\n\t(function override_confirm_for_clear_assignment() {\n\t\tconst original_confirm = frappe.confirm;\n\n\t\tfrappe.confirm = function (message, on_yes, on_no) {\n\t\t\tconst is_clear_assignment_msg =\n\t\t\t\tmessage &&\n\t\t\t\t(message.indexOf(\"clear the assignments\") !== -1 ||\n\t\t\t\t\tmessage.indexOf(\"clear the assignment\") !== -1);\n\n\t\t\tif (!is_clear_assignment_msg) {\n\t\t\t\treturn original_confirm.call(this, message, on_yes, on_no);\n\t\t\t}\n\n\t\t\tconst listview = get_listview_fallback();\n\t\t\tif (!listview) {\n\t\t\t\treturn original_confirm.call(this, message, on_yes, on_no);\n\t\t\t}\n\n\t\t\tconst names = get_selected_docnames(listview);\n\t\t\tif (!ensure_names(names)) return;\n\n\t\t\t// Open dialog directly without confirm\n\t\t\topen_assign_dialog_for_clear(listview, names);\n\t\t};\n\t})();\n\n\t// -----------------------------\n\t// Listview settings\n\t// -----------------------------\n\tfrappe.listview_settings[DOCTYPE] = {\n\t\tadd_fields: [\"original_lead\", \"is_duplicate\", \"status\"],\n\n\t\tget_indicator(doc) {\n\t\t\tif (cint(doc.is_duplicate)) {\n\t\t\t\treturn [__(\"Duplicate\"), \"yellow\", \"is_duplicate,=,1\"];\n\t\t\t}\n\t\t\tif (cint(doc.original_lead)) {\n\t\t\t\treturn [__(\"Original\"), \"orange\", \"original_lead,=,1\"];\n\t\t\t}\n\t\t},\n\n\t\tonload(listview) {\n\t\t\tfrappe.after_ajax(() => {\n\t\t\t\tif (listview.page._crm_ui_ready) return;\n\t\t\t\tlistview.page._crm_ui_ready = true;\n\n\t\t\t\tlet activeBtn = null;\n\n\t\t\t\tconst styleBtn = ($btn, base, hover, active) => {\n\t\t\t\t\t$btn\n\t\t\t\t\t\t.css({\n\t\t\t\t\t\t\tbackgroundColor: base,\n\t\t\t\t\t\t\tcolor: \"white\",\n\t\t\t\t\t\t\tfontWeight: 600,\n\t\t\t\t\t\t\tborderRadius: \"6px\",\n\t\t\t\t\t\t\tpadding: \"6px 12px\",\n\t\t\t\t\t\t\ttransition: \"all .2s ease-in-out\",\n\t\t\t\t\t\t\tboxShadow: \"0 2px 4px rgba(0,0,0,.1)\",\n\t\t\t\t\t\t\tmarginRight: \"6px\",\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.hover(\n\t\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\t\tif (this !== activeBtn) $(this).css(\"background-color\", hover);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\t\tif (this !== activeBtn) $(this).css(\"background-color\", base);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t);\n\t\t\t\t};\n\n\t\t\t\tconst markActive = ($btn, base, active) => {\n\t\t\t\t\tif (activeBtn) {\n\t\t\t\t\t\t$(activeBtn).css({\n\t\t\t\t\t\t\tbackgroundColor: $(activeBtn).data(\"base\"),\n\t\t\t\t\t\t\tboxShadow: \"0 2px 4px rgba(0,0,0,.1)\",\n\t\t\t\t\t\t\ttransform: \"scale(1)\",\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tactiveBtn = $btn[0];\n\t\t\t\t\t$btn.css({\n\t\t\t\t\t\tbackgroundColor: active,\n\t\t\t\t\t\tboxShadow: \"0 4px 6px rgba(0,0,0,.15)\",\n\t\t\t\t\t\ttransform: \"scale(1.03)\",\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\t// Duplicate Leads button\n\t\t\t\tconst btnDuplicate = listview.page.add_inner_button(__(\"Duplicate Leads\"), () => {\n\t\t\t\t\tlistview.filter_area.clear();\n\t\t\t\t\tlistview.filter_area.add([[DOCTYPE, \"is_duplicate\", \"=\", 1]]);\n\t\t\t\t\tlistview.run();\n\t\t\t\t\tmarkActive(btnDuplicate, \"#FF6B35\", \"#cc4c24\");\n\t\t\t\t});\n\t\t\t\tbtnDuplicate.data(\"base\", \"#FF6B35\");\n\t\t\t\tstyleBtn(btnDuplicate, \"#FF6B35\", \"#e85c2b\", \"#cc4c24\");\n\n\t\t\t\t// Original Leads button\n\t\t\t\tconst btnParent = listview.page.add_inner_button(__(\"Original Leads\"), () => {\n\t\t\t\t\tlistview.filter_area.clear();\n\t\t\t\t\tlistview.filter_area.add([[DOCTYPE, \"original_lead\", \"=\", 1]]);\n\t\t\t\t\tlistview.run();\n\t\t\t\t\tmarkActive(btnParent, \"#1E3A8A\", \"#0f1e4f\");\n\t\t\t\t});\n\t\t\t\tbtnParent.data(\"base\", \"#1E3A8A\");\n\t\t\t\tstyleBtn(btnParent, \"#1E3A8A\", \"#162c6a\", \"#0f1e4f\");\n\n\t\t\t\t// Without Duplicates button\n\t\t\t\tconst btnWithout = listview.page.add_inner_button(__(\"Without Duplicates\"), () => {\n\t\t\t\t\tlistview.filter_area.clear();\n\t\t\t\t\tlistview.filter_area.add([[DOCTYPE, \"is_duplicate\", \"!=\", 1]]);\n\t\t\t\t\tlistview.run();\n\t\t\t\t\tmarkActive(btnWithout, \"#334155\", \"#111827\");\n\t\t\t\t});\n\t\t\t\tbtnWithout.data(\"base\", \"#334155\");\n\t\t\t\tstyleBtn(btnWithout, \"#334155\", \"#1f2937\", \"#111827\");\n\n\t\t\t\t// Default filter\n\t\t\t\tbtnWithout.trigger(\"click\");\n\t\t\t});\n\t\t},\n\n\t\t// Override get_actions to customize Clear Assignment\n\t\tget_actions: function () {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tlabel: __(\"Clear Assignment\"),\n\t\t\t\t\taction: function () {\n\t\t\t\t\t\tconst listview = get_listview_fallback();\n\t\t\t\t\t\tif (!listview) {\n\t\t\t\t\t\t\tfrappe.msgprint(__(\"List view is not ready. Please try again.\"));\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst names = get_selected_docnames(listview);\n\t\t\t\t\t\tif (!ensure_names(names)) return;\n\n\t\t\t\t\t\topen_assign_dialog_for_clear(listview, names);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t];\n\t\t},\n\t};\n\n\t// -----------------------------\n\t// Main dialog function (Clear then optional Assign)\n\t// -----------------------------\n\tfunction open_assign_dialog_for_clear(listview, docnames) {\n\t\t// Get assignable users\n\t\tfrappe.call({\n\t\t\tmethod: \"crm.fcrm.permissions.assign_to.get_assignable_users\",\n\t\t\targs: {\n\t\t\t\tdoctype: DOCTYPE,     // ✅ fixed\n\t\t\t\tname: docnames[0],    // ✅ always a real docname\n\t\t\t},\n\t\t\tcallback: function (r) {\n\t\t\t\tconst assignable_users = (r.message || []).map((u) => u.name || u);\n\n\t\t\t\tconst d = new frappe.ui.Dialog({\n\t\t\t\t\ttitle: __(\"Assign To\"),\n\t\t\t\t\tfields: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: __(\"Assign To\"),\n\t\t\t\t\t\t\tfieldname: \"assign_to\",\n\t\t\t\t\t\t\tfieldtype: \"MultiSelectPills\",\n\t\t\t\t\t\t\tget_data: function (txt) {\n\t\t\t\t\t\t\t\tif (!txt) return [];\n\n\t\t\t\t\t\t\t\treturn frappe.db\n\t\t\t\t\t\t\t\t\t.get_list(\"User\", {\n\t\t\t\t\t\t\t\t\t\tfilters: assignable_users.length\n\t\t\t\t\t\t\t\t\t\t\t? { name: [\"in\", assignable_users] }\n\t\t\t\t\t\t\t\t\t\t\t: {},\n\t\t\t\t\t\t\t\t\t\tlimit: 20,\n\t\t\t\t\t\t\t\t\t\tor_filters: [\n\t\t\t\t\t\t\t\t\t\t\t[\"full_name\", \"like\", \"%\" + txt + \"%\"],\n\t\t\t\t\t\t\t\t\t\t\t[\"name\", \"like\", \"%\" + txt + \"%\"],\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.then((users) =>\n\t\t\t\t\t\t\t\t\t\tusers.map((u) => ({\n\t\t\t\t\t\t\t\t\t\t\tvalue: u.name,\n\t\t\t\t\t\t\t\t\t\t\tdescription: u.full_name || u.name,\n\t\t\t\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tprimary_action_label: __(\"Update\"),\n\t\t\t\t\tprimary_action: function (values) {\n\t\t\t\t\t\tconst assignees = values.assign_to || [];\n\n\t\t\t\t\t\t// 1) Clear existing assignments (bulk)\n\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\tmethod: \"crm.api.doc.remove_multiple_assignments\",\n\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\tdoctype: DOCTYPE,   // ✅ fixed\n\t\t\t\t\t\t\t\tnames: docnames,    // ✅ array of docnames\n\t\t\t\t\t\t\t\tignore_permissions: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\t\t// 2) If assignees selected, assign in ONE bulk call\n\t\t\t\t\t\t\t\tif (assignees.length > 0) {\n\t\t\t\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\t\t\t\tmethod: \"crm.api.doc.assign_without_rule\",\n\t\t\t\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t\t\t\tdoctype: DOCTYPE,   // ✅ fixed\n\t\t\t\t\t\t\t\t\t\t\tnames: docnames,    // ✅ bulk\n\t\t\t\t\t\t\t\t\t\t\tassign_to: assignees,\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\t\t\t\t\td.hide();\n\t\t\t\t\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\t\t\t\t\tmessage: __(\"Assigned successfully\"),\n\t\t\t\t\t\t\t\t\t\t\t\tindicator: \"green\",\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t\tlistview.refresh();\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\td.hide();\n\t\t\t\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\t\t\t\tmessage: __(\"Assignment cleared successfully\"),\n\t\t\t\t\t\t\t\t\t\tindicator: \"green\",\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tlistview.refresh();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\td.show();\n\t\t\t},\n\t\t});\n\t}\n})();\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lead",
  "enabled": 1,
  "modified": "2025-08-29 23:41:11.146782",
  "module": "CRM",
  "name": "Filtered Buttons",
  "script": "// Override frappe.confirm globally to intercept Clear Assignment confirm dialog\n(function() {\n    const original_confirm = frappe.confirm;\n    frappe.confirm = function(message, on_yes, on_no) {\n        // Check if this is the Clear Assignment confirm dialog\n        if (message && (message.indexOf('clear the assignments') !== -1 || message.indexOf('clear the assignment') !== -1)) {\n            // Get current listview\n            const listview = cur_list || frappe.views.list_view;\n            if (!listview) {\n                return original_confirm.call(this, message, on_yes, on_no);\n            }\n            \n            // Get selected items\n            const selected = listview.get_checked_items ? listview.get_checked_items(true) : [];\n            if (selected.length === 0) {\n                frappe.msgprint(__('Please select at least one lead'));\n                return;\n            }\n            \n            // Open assignment dialog directly without confirm\n            open_assign_dialog_for_clear(listview, selected);\n            return;\n        }\n        // For other confirm dialogs, use original function\n        return original_confirm.call(this, message, on_yes, on_no);\n    };\n})();\n\nfrappe.listview_settings['CRM Lead'] = {\n    add_fields: ['original_lead', 'is_duplicate', 'status'],\n\n    get_indicator(doc) {\n        if (cint(doc.is_duplicate)) {\n            return [__('Duplicate'), 'yellow', 'is_duplicate,=,1'];\n        }\n        if (cint(doc.original_lead)) {\n            return [__('Original'), 'orange', 'original_lead,=,1'];\n        }\n    },\n\n    onload(listview) {\n        frappe.after_ajax(() => {\n            if (listview.page._crm_ui_ready) return;\n            listview.page._crm_ui_ready = true;\n\n            let activeBtn = null;\n\n            const styleBtn = ($btn, base, hover, active) => {\n                $btn.css({\n                    backgroundColor: base,\n                    color: 'white',\n                    fontWeight: 600,\n                    borderRadius: '6px',\n                    padding: '6px 12px',\n                    transition: 'all .2s ease-in-out',\n                    boxShadow: '0 2px 4px rgba(0,0,0,.1)',\n                    marginRight: '6px'\n                })\n                .hover(\n                    function(){ if (this !== activeBtn) $(this).css('background-color', hover); },\n                    function(){ if (this !== activeBtn) $(this).css('background-color', base); }\n                );\n            };\n\n            const markActive = ($btn, base, active) => {\n                if (activeBtn) {\n                    $(activeBtn).css({\n                        backgroundColor: $(activeBtn).data(\"base\"),\n                        boxShadow: '0 2px 4px rgba(0,0,0,.1)',\n                        transform: 'scale(1)'\n                    });\n                }\n                activeBtn = $btn[0];\n                $btn.css({\n                    backgroundColor: active,\n                    boxShadow: '0 4px 6px rgba(0,0,0,.15)',\n                    transform: 'scale(1.03)'\n                });\n            };\n\n            // Duplicate Leads button\n            const btnDuplicate = listview.page.add_inner_button(__('Duplicate Leads'), () => {\n                listview.filter_area.clear();\n                listview.filter_area.add([['CRM Lead', 'is_duplicate', '=', 1]]);\n                listview.run();\n                markActive(btnDuplicate, '#FF6B35', '#cc4c24');\n            });\n            btnDuplicate.data(\"base\", \"#FF6B35\");\n            styleBtn(btnDuplicate, '#FF6B35', '#e85c2b', '#cc4c24');\n\n            // Parent Leads button\n            const btnParent = listview.page.add_inner_button(__('Original Leads'), () => {\n                listview.filter_area.clear();\n                listview.filter_area.add([['CRM Lead', 'original_lead', '=', 1]]);\n                listview.run();\n                markActive(btnParent, '#1E3A8A', '#0f1e4f');\n            });\n            btnParent.data(\"base\", \"#1E3A8A\");\n            styleBtn(btnParent, '#1E3A8A', '#162c6a', '#0f1e4f');\n\n            // Without Duplicates button\n            const btnWithout = listview.page.add_inner_button(__('Without Duplicates'), () => {\n                listview.filter_area.clear();\n                listview.filter_area.add([['CRM Lead', 'is_duplicate', '!=', 1]]);\n                listview.run();\n                markActive(btnWithout, '#334155', '#111827');\n            });\n            btnWithout.data(\"base\", \"#334155\");\n            styleBtn(btnWithout, '#334155', '#1f2937', '#111827');\n\n            // ✅ Trigger \"Without Duplicates\" by default\n            btnWithout.trigger(\"click\");\n        });\n    },\n    \n    // Override get_actions to customize Clear Assignment\n    get_actions: function() {\n        const listview = cur_list;\n        return [\n            {\n                label: __('Clear Assignment'),\n                action: function() {\n                    const selected = listview.get_checked_items(true);\n                    if (selected.length === 0) {\n                        frappe.msgprint(__('Please select at least one lead'));\n                        return;\n                    }\n                    // Open assignment dialog directly without confirm\n                    open_assign_dialog_for_clear(listview, selected);\n                }\n            }\n        ];\n    }\n};\n\nfunction open_assign_dialog_for_clear(listview, selected_items) {\n    // Get assignable users\n    frappe.call({\n        method: 'crm.fcrm.permissions.assign_to.get_assignable_users',\n        args: {\n            doctype: 'Lead',\n            name: selected_items[0]?.name || ''\n        },\n        callback: function(r) {\n            const assignable_users = (r.message || []).map(u => u.name || u);\n            \n            // Create assignment dialog\n            const d = new frappe.ui.Dialog({\n                title: __('Assign To'),\n                fields: [\n                    {\n                        label: __('Assign To'),\n                        fieldname: 'assign_to',\n                        fieldtype: 'MultiSelectPills',\n                        get_data: function(txt) {\n                            if (!txt) return [];\n                            return frappe.db.get_list('User', {\n                                filters: assignable_users.length ? {\n                                    'name': ['in', assignable_users]\n                                } : {},\n                                limit: 20,\n                                or_filters: [\n                                    ['full_name', 'like', '%' + txt + '%'],\n                                    ['name', 'like', '%' + txt + '%']\n                                ]\n                            }).then(users => {\n                                return users.map(u => ({\n                                    value: u.name,\n                                    description: u.full_name || u.name\n                                }));\n                            });\n                        }\n                    }\n                ],\n                primary_action_label: __('Update'),\n                primary_action: function(values) {\n                    const assignees = values.assign_to || [];\n                    // Filter out undefined/null names and ensure we have valid document names\n                    const names = selected_items\n                        .map(item => item.name || item)\n                        .filter(name => name && (typeof name === 'string' ? name.trim() !== '' : true));\n                    \n                    if (names.length === 0) {\n                        frappe.msgprint(__('No valid document names found in selected items'));\n                        return;\n                    }\n                    \n                    // Clear existing assignments first, then assign new ones\n                    frappe.call({\n                        method: 'crm.api.doc.remove_multiple_assignments',\n                        args: {\n                            doctype: 'Lead',\n                            names: names,\n                            ignore_permissions: true\n                        },\n                        callback: function() {\n                            if (assignees.length > 0) {\n                                // Use assign_without_rule for bulk assignment to bypass assignment rules\n                                const validNames = names.filter(name => name && (typeof name === 'string' ? name.trim() !== '' : true));\n                                \n                                if (validNames.length === 0) {\n                                    frappe.msgprint(__('No valid document names found'));\n                                    return;\n                                }\n                                \n                                frappe.call({\n                                    method: 'crm.api.doc.assign_without_rule',\n                                    args: {\n                                        doctype: 'Lead',\n                                        assign_to: assignees,\n                                        names: validNames,\n                                        description: ''\n                                    },\n                                    callback: function(r) {\n                                        if (r.exc) {\n                                            frappe.msgprint(__('Error assigning: {0}', [r.exc]));\n                                            return;\n                                        }\n                                        d.hide();\n                                        frappe.show_alert({\n                                            message: __('Assigned successfully'),\n                                            indicator: 'green'\n                                        });\n                                        listview.refresh();\n                                    }\n                                });\n                            } else {\n                                d.hide();\n                                frappe.show_alert({\n                                    message: __('Assignment cleared successfully'),\n                                    indicator: 'green'\n                                });\n                                listview.refresh();\n                            }\n                        }\n                    });\n                }\n            });\n            \n            d.show();\n        }\n    });\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lead",
  "enabled": 1,
  "modified": "2025-08-04 13:16:59.867962",
  "module": "CRM",
  "name": "Highlight Orginal lead has Duplicates",
  "script": "frappe.ui.form.on('CRM Lead', {\n  refresh(frm) {\n\n    if (frm.dashboard && frm.dashboard.wrapper) {\n      frm.dashboard.wrapper.find('.indicator').remove();\n    }\n\n    if (frm.doc.original_lead == 1) {\n      frm.dashboard.add_indicator(__('Has Duplicates'), 'orange');\n    }\n  }\n});",
  "view": "List"
 }
]